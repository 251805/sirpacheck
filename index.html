<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pagbilao Weather & Traffic Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f7fa; }
    header { background: #0077b6; color: white; padding: 15px; text-align: center; }
    section { padding: 20px; }
    h2 { border-bottom: 2px solid #0077b6; padding-bottom: 5px; }
    .barangay-group { margin-bottom: 20px; }
    .barangay { background: white; border-radius: 10px; padding: 15px; margin: 10px 0; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    .barangay h3 { margin: 0 0 10px; color: #0077b6; }
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
    iframe { border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <header>
    <h1>Pagbilao Weather & Traffic Dashboard</h1>
    <p>Barangay Weather • Maharlika Highway Traffic • PAGASA Forecast</p>
  </header>

  <section>
    <h2>🌦 Weather by Barangay</h2>
    <div id="weather"></div>
  </section>

  <section>
    <h2>🚦 Traffic (Maharlika Highway)</h2>
    <div id="traffic">Loading traffic data...</div>
  </section>

  <section>
    <h2>🌍 Windy Map</h2>
    <iframe width="100%" height="400" src="https://embed.windy.com/embed2.html?lat=13.972&lon=121.687&detailLat=13.972&detailLon=121.687&width=650&height=450&zoom=11&level=surface&overlay=wind&product=ecmwf&menu=&message=true&marker=true&calendar=now&pressure=true&type=map&location=coordinates&detail=true&metricWind=default&metricTemp=default&radarRange=-1" frameborder="0"></iframe>
  </section>

  <section>
    <h2>📺 Latest PAGASA Forecast</h2>
    <div id="pagasa-video">
      <p>Loading latest PAGASA forecast video...</p>
    </div>
  </section>

  <script>
    // OpenWeatherMap Setup
    const OWM_KEY = "d77dbc9c66952dae67f86c58ab653dec";
    const barangays = [
      "Añato","Alupaye","Antipolo","Bagumbungan Iba.","Bagumbungan Ila.","Bantigue","Bigo","Binahaan","Bukal",
      "Castillo (Poblacion)","Daungan (Poblacion)","Del Carmen (Poblacion)","Ikirin",
      "Malicboy Kan.","Malicboy Sil.","Mapagong","Mayhay","Palsabangon Iba.","Palsabangon Ila.",
      "Parang (Poblacion)","Pinagbayanan","Polo Iba.","Polo Ila.","Sta. Catalina (Poblacion)",
      "Talipan","Tambak (Poblacion)","Tukalan"
    ];

    async function fetchWeather(barangay) {
      const url = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(barangay)},Pagbilao,PH&units=metric&appid=${OWM_KEY}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.cod === 200) {
          return `
            <div class="barangay">
              <h3>${barangay}</h3>
              <p>🌡 Temp: ${data.main.temp}°C (feels like ${data.main.feels_like}°C)</p>
              <p>💧 Humidity: ${data.main.humidity}%</p>
              <p>💨 Wind: ${data.wind.speed} m/s</p>
              <p>☁️ Clouds: ${data.clouds.all}%</p>
              <p>🌧 Rain chance: ${(data.rain ? data.rain["1h"] : 0)} mm (last 1h)</p>
            </div>
          `;
        } else {
          return `<div class="barangay"><h3>${barangay}</h3><p>⚠️ Weather data not available</p></div>`;
        }
      } catch (err) {
        return `<div class="barangay"><h3>${barangay}</h3><p>❌ Error fetching data</p></div>`;
      }
    }

    async function loadWeather() {
      const container = document.getElementById("weather");
      container.innerHTML = "<p>Loading weather data...</p>";
      const results = await Promise.all(barangays.map(fetchWeather));
      container.innerHTML = `<div class="cards">${results.join("")}</div>`;
    }

    loadWeather();

    // TomTom Traffic API
    const TOMTOM_KEY = "AnWOBls5vLcwsWYRDnxX8Qf2UKPKHkHb";
    async function loadTraffic() {
      const url = `https://api.tomtom.com/traffic/services/4/flowSegmentData/absolute/10/json?point=13.972,121.687&unit=KMPH&key=${TOMTOM_KEY}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.flowSegmentData) {
          const current = data.flowSegmentData.currentSpeed;
          const free = data.flowSegmentData.freeFlowSpeed;
          const conf = data.flowSegmentData.confidence * 100;
          document.getElementById("traffic").innerHTML = `
            <p>🚗 Current Speed: ${current} km/h</p>
            <p>🛣 Normal Speed: ${free} km/h</p>
            <p>📊 Confidence: ${conf.toFixed(0)}%</p>
          `;
        } else {
          document.getElementById("traffic").innerText = "⚠️ No traffic data available.";
        }
      } catch (err) {
        document.getElementById("traffic").innerText = "❌ Error fetching traffic data.";
      }
    }

    loadTraffic();

    // YouTube API for PAGASA
    const YT_KEY = "AIzaSyAdfwN8_02GUGXTW-cnICzYvWYt1etG4JM";
    const CHANNEL_ID = "UCpyLikj1x70S8UPxVqsPr6g";

    async function loadPagasaVideo() {
      try {
        let url = `https://www.googleapis.com/youtube/v3/search?key=${YT_KEY}&channelId=${CHANNEL_ID}&part=snippet&order=date&maxResults=1&type=video`;
        let res = await fetch(url);
        let data = await res.json();

        if (!data.items || data.items.length === 0) {
          url = `https://www.googleapis.com/youtube/v3/search?key=${YT_KEY}&channelId=${CHANNEL_ID}&part=snippet&eventType=live&type=video`;
          res = await fetch(url);
          data = await res.json();
        }

        if (data.items && data.items.length > 0) {
          const video = data.items[0];
          const videoId = video.id.videoId;
          const title = video.snippet.title;
          const published = new Date(video.snippet.publishedAt).toLocaleString();

          document.getElementById("pagasa-video").innerHTML = `
            <h3>${title}</h3>
            <p>📅 Published: ${published}</p>
            <iframe width="100%" height="315"
              src="https://www.youtube.com/embed/${videoId}"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen>
            </iframe>
          `;
        } else {
          document.getElementById("pagasa-video").innerText = "No recent PAGASA forecast video found.";
        }
      } catch (err) {
        console.error(err);
        document.getElementById("pagasa-video").innerText = "Error loading PAGASA video.";
      }
    }

    loadPagasaVideo();
  </script>
</body>
</html>
